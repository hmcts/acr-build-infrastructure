parameters:
  - name: location
    displayName: Location
    type: string
    default: 'UK South'
    values:
      - 'UK South'
      - 'UK West'

  - name: env
    displayName: Environment
    type: string
    default: 'PROD'
    values:
      - PROD

name: HMCTS Shared Services AKS Azure Infrastructure Deployment Pipeline
trigger:
  - none

variables:
  - name: gaServiceConnection
    value: OPS-APPROVAL-GATE-${{ parameters.env }}-ENVS
  - name: tfversion
    value: 0.13.4
  # If another project comes along and wants to use the same pipeline file then make this a variable in the UI
  # but it might be better to template the pipeline more and have a different pipeline file
  # so that someone doesn't pick the wrong var in the dropdown
  - name: project
    value: sds
  # same comment as above ^^
  - name: serviceConnection
    value: DTS-SHAREDSERVICES-${{ parameters.env }}

stages:

  - stage: ACR
    displayName: 'Deploy Azure Container Registries'
    variables:
      armClientSecret: $[ stageDependencies.ReadKeyVault.ReadKeyVault.outputs['SetSubscriptionSP.ARM_CLIENT_SECRET'] ]
      controlStorageAccount: $[ stageDependencies.ReadKeyVault.ReadKeyVault.outputs['SetControlVars.controlStorageAccount'] ]
    jobs:
      - job: DeployInfrastructure
        steps:
          - template: pipeline-steps/deploy-service.yaml
            parameters:
              environment: PROD
              location: ${{ parameters.location }}
              stack: 'acr'
              project: $(project)
              tfversion: $(tfversion)
